<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>JP → KO (Furigana + DeepL)</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    textarea { width: 100%; height: 100px; font-size: 16px; }
    button { margin-top: 10px; padding: 8px 16px; font-size: 16px; }
    .result { margin-top: 20px; padding: 12px; background: #f5f5f5; border-radius: 8px; }
    ruby rt { font-size: 14px; color: #666; }
  </style>
  <!-- 가장 기본형: CDN 불러오기 -->
  <script src="https://unpkg.com/kuromoji@0.1.2/dist/kuromoji.js"></script>
  <script src="https://unpkg.com/kuroshiro@1.2.0/dist/kuroshiro.min.js"></script>
</head>
<body>
  <h2>일본어 → 한국어 (후리가나 + DeepL)</h2>

  <textarea id="inputText" placeholder="例：日本語を勉強する"></textarea>
  <button id="runBtn">변환 & 번역</button>

  <div class="result" id="resultBox" style="display:none">
    <div id="rubyArea"></div>
    <div id="translationArea"></div>
  </div>

  <script>
    const inputEl = document.getElementById("inputText");
    const runBtn = document.getElementById("runBtn");
    const resultBox = document.getElementById("resultBox");
    const rubyArea = document.getElementById("rubyArea");
    const translationArea = document.getElementById("translationArea");

    let kuroshiro, kuroReady = false;

    // Kuroshiro 초기화
    function initKuroshiro() {
      return new Promise((resolve, reject) => {
        kuromoji.builder({ dicPath: "https://unpkg.com/kuromoji@0.1.2/dict/" })
          .build((err, tokenizer) => {
            if (err) return reject(err);
            kuroshiro = new Kuroshiro();
            kuroshiro.init(tokenizer).then(() => {
              kuroReady = true;
              resolve();
            }).catch(reject);
          });
      });
    }

    // 후리가나 변환
    async function makeFurigana(text) {
      if (!kuroReady) await initKuroshiro();
      return await kuroshiro.convert(text, { mode: "furigana", to: "hiragana" });
    }

    // DeepL 프록시 (Cloudflare Worker)
    const PROXY_URL = "https://solitary-mud-8caf.rlaalsrbr.workers.dev/translate";

    async function translate(text) {
      const res = await fetch(PROXY_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, target: "KO" })
      });
      const data = await res.json();
      return data.translation || "";
    }

    async function runAll() {
      const text = inputEl.value.trim();
      if (!text) return;
      resultBox.style.display = "block";
      rubyArea.innerHTML = "";
      translationArea.textContent = "";

      try {
        const [furiganaHtml, ko] = await Promise.all([
          makeFurigana(text),
          translate(text)
        ]);
        rubyArea.innerHTML = furiganaHtml;
        translationArea.textContent = "→ " + ko;
      } catch (e) {
        rubyArea.textContent = "에러: " + e.message;
      }
    }

    runBtn.addEventListener("click", runAll);
  </script>
</body>
</html>

