<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Furigana + 번역</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --card:#11161f; --ink:#e6edf3; --line:#223044; --muted:#9fb0c2; --accent:#5aa9ff; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,sans-serif}
    header{padding:16px 20px;border-bottom:1px solid var(--line)}
    h1{margin:0;font-size:16px;font-weight:600}
    main{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
    .label{font-size:13px;color:var(--muted);margin-bottom:8px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:#182233;color:var(--ink);border:1px solid var(--line);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#1e2a3f}
    .btn.primary{background:var(--accent);color:#06111e;border-color:#2d80e4;font-weight:600}
    .error{color:#ffb3b3}
    textarea{width:100%;min-height:120px;background:#0e141c;color:#e6edf3;border:1px solid var(--line);border-radius:10px;padding:12px;resize:vertical;line-height:1.5}
    ruby{ruby-position:over}
    ruby rt{font-size:.8em;color:#b9c8d8;opacity:1;transition:opacity .15s ease}
    #rubyOut.ruby-off ruby rt{opacity:0}     /* 루비 토글: 줄간격 유지 */
    .tok{padding:1px 2px;border-radius:6px;cursor:pointer}
    .tok:hover{background:#1a2436}
    .tok[data-clickable="0"]{cursor:default}
    .tok ruby, .tok rb, .tok rt { pointer-events:none; }
    .pane{height:38vh; min-height:28vh; max-height:60vh; overflow:auto; background:#0e141c; border:1px solid var(--line); border-radius:10px; padding:12px; white-space:pre-wrap}
    @media (max-height:760px){ .pane{height:34vh} }
    details summary{list-style:none; cursor:pointer; display:flex; align-items:center; gap:8px; user-select:none}
    details summary::-webkit-details-marker{display:none}
    .chev{transition:transform .2s ease}
    details[open] .chev{transform:rotate(90deg)}
    .hint{margin-left:auto; color:#9fb0c2; font-size:12px}

    /* 팝업 */
    #pop{position:fixed;z-index:9999;max-width:340px;display:none;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .popTitle{font-size:22px;font-weight:800;line-height:1.2;display:inline-block;color:#e6edf3;text-decoration:none}
    .popTitle rt{font-size:.7em}
    .popSub{font-size:12px;color:#9fb0c2;margin-left:6px}
    .popTrans{font-size:15px;color:#cfe0f2;margin-top:8px;word-break:break-word}
    .popActions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  </style>
</head>
<body>
<header><h1>Furigana + 번역</h1></header>
<main>

  <!-- 입력(접힘) -->
  <section class="card">
    <details id="inputBox">
      <summary>
        <span class="chev">▶</span>
        <strong>입력 텍스트</strong>
        <span class="hint">클릭하여 펼치기 · 단축키 Ctrl/⌘+Enter</span>
      </summary>
      <div style="margin-top:10px">
        <textarea id="input" placeholder="일본어 텍스트를 붙여넣고 ‘후리가나 & 번역’ 버튼을 누르세요。"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="runBtn" type="button">후리가나 & 번역</button>
        </div>
      </div>
    </details>
  </section>

  <!-- 원문(루비 토글, 독립 스크롤) -->
  <section class="card">
    <div class="label" style="margin-bottom:8px">원문</div>
    <div id="rubyOut" class="pane" aria-live="polite"></div>
    <div class="row" style="margin-top:8px; justify-content:flex-end">
      <button class="btn" id="btnToggleRuby" type="button">루비 끄기</button>
    </div>
  </section>

  <!-- 번역(독립 스크롤) -->
  <section class="card">
    <div class="label" style="margin-bottom:8px">번역</div>
    <div id="transOut" class="pane" aria-live="polite"></div>
  </section>
</main>

<!-- 단어 팝업 -->
<div id="pop">
  <!-- 헤더: 기본형(큰 글씨, 루비), (선택 글자) 작게, 전체 링크 -->
  <a id="popLink" class="popTitle" href="#" target="_blank" rel="noopener"></a>
  <span id="popSub" class="popSub"></span>
  <!-- 번역 결과 텍스트 (라벨 없음) -->
  <div id="popDeepl" class="popTrans"></div>
  <div class="popActions"><button class="btn" id="popClose" type="button">닫기</button></div>
</div>

<script>
/* ===== 고정 엔드포인트 ===== */
const FURIGANA_URL = "https://furigana-api-345684237835.asia-northeast3.run.app/furigana";
const DEEPL_URL    = "https://solitary-mud-8caf.rlaalsrbr.workers.dev/translate";

/* ===== 유틸 ===== */
const $ = function(s){ return document.querySelector(s); };
function escapeHtml(s){ var d=document.createElement("div"); d.innerText=s; return d.innerHTML; }
function escapeAttr(s){ return String(s).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;"); }
function kata2hira(s){ return s.replace(/[\u30a1-\u30f6]/g, function(ch){ return String.fromCharCode(ch.charCodeAt(0)-0x60); }); }
function hasKanji(s){ return /[\u4E00-\u9FFF]/.test(s); }
function isKanaOnly(s){ return /^[\u3040-\u309F\u30A0-\u30FF]+$/.test(s); }
function withTimeout(run, ms, label){
  if(ms==null) ms=45000; if(!label) label="요청";
  var ctrl = new AbortController(); var t = setTimeout(function(){ ctrl.abort(); }, ms);
  return Promise.race([
    run(ctrl.signal),
    (async function(){ await new Promise(function(r){ return setTimeout(r, ms+50); }); throw new Error(label+" 타임아웃("+ms+"ms)"); })()
  ]).finally(function(){ clearTimeout(t); });
}

/* ===== API ===== */
async function callFurigana(text){
  var body = { text: text, perChar: false };
  var fetcher = function(signal){
    return fetch(FURIGANA_URL, {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body), signal: signal
    }).then(function(r){ if(!r.ok) throw new Error("Furigana API " + r.status); return r.json(); });
  };
  return withTimeout(fetcher, 45000, "Furigana");
}
async function callDeepL(text, src, tgt){
  if(!src) src="JA"; if(!tgt) tgt="KO";
  var body = { text: text, sourceLang: src, targetLang: tgt };
  var fetcher = function(signal){
    return fetch(DEEPL_URL, {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body), signal: signal
    }).then(function(r){ if(!r.ok) throw new Error("DeepL " + r.status); return r.json(); });
  };
  return withTimeout(fetcher, 45000, "DeepL");
}

/* ===== 상태 ===== */
var lastTokens = null;
var rubyOn = true;

/* ===== ruby DOM(항상 생성: rt를 CSS로 숨김) ===== */
function buildRubyTokens(tokens){
  return (tokens||[]).map(function(t, idx){
    var s = String(t.surface || "");
    var r = String(t.reading || "");
    var lemma = String(t.lemma || s);
    var rt = r ? kata2hira(r) : "";
    var inner = (hasKanji(s) && rt)
      ? '<ruby><rb>' + escapeHtml(s) + '</rb><rt>' + escapeHtml(rt) + '</rt></ruby>'
      : escapeHtml(s);
    var clickable = s.trim() ? "1" : "0";
    return '<span class="tok" data-i="'+idx+'" data-clickable="'+clickable+'"'
         + ' data-surface="'+escapeAttr(s)+'"'
         + ' data-lemma="'+escapeAttr(lemma)+'"'
         + ' data-reading="'+escapeAttr(rt)+'">'+ inner +'</span>';
  }).join("");
}
function renderText(){
  if(!lastTokens){ return; }
  $("#rubyOut").innerHTML = buildRubyTokens(lastTokens);
  $("#rubyOut").classList.toggle("ruby-off", !rubyOn);
  $("#btnToggleRuby").textContent = rubyOn ? "루비 끄기" : "루비 켜기";
}

/* ===== 네이버 사전 링크 생성(검색 페이지로 이동) ===== */
function buildNaverUrl(lemma){
  var q = encodeURIComponent(lemma || "");
  // 한국어 UI의 일본어사전도 SPA라 해시 라우팅을 씀. 검색 결과로 이동(안정).
  return "https://ja.dict.naver.com/#/search?query=" + q;
}

/* ===== 팝업 ===== */
var pop = $("#pop");
var popLink = $("#popLink");
var popSub  = $("#popSub");
var popDeepl = $("#popDeepl");

function openPop(x, y, payload){
  var surface = payload.surface || "";
  var lemma   = payload.lemma   || surface;
  var reading = payload.reading || "";

  // 헤더: 기본형을 제목으로, rt는 위에(루비), 선택 글자는 괄호로 작게
  var titleHtml;
  if(reading && hasKanji(lemma)){
    titleHtml = '<ruby><rb>' + escapeHtml(lemma) + '</rb><rt>' + escapeHtml(reading) + '</rt></ruby>';
  } else {
    titleHtml = escapeHtml(lemma);
  }
  popLink.innerHTML = titleHtml;
  popLink.href = buildNaverUrl(lemma);
  popSub.textContent = surface && surface !== lemma ? "(" + surface + ")" : "";

  // 번역
  popDeepl.textContent = "불러오는 중…";
  callDeepL(lemma || surface, "JA", "KO").then(function(res){
    var t = res.translation || res.result || res.data || "";
    popDeepl.textContent = t || "(결과 없음)";
  }).catch(function(e){
    popDeepl.textContent = "에러: " + ((e&&e.message)?e.message:String(e));
  });

  // 위치 및 표시
  var pad=8, vw=window.innerWidth, vh=window.innerHeight;
  pop.style.left = Math.min(x+pad, vw-360) + "px";
  pop.style.top  = Math.min(y+pad, vh-240) + "px";
  pop.style.display = "block";
}
function closePop(){ pop.style.display = "none"; }
$("#popClose").addEventListener("click", closePop);
document.addEventListener("click", function(e){
  if(pop.style.display==="block"){
    if(!pop.contains(e.target) && !e.target.closest(".tok")) closePop();
  }
});

/* ===== 실행 ===== */
async function runBoth(){
  var text = $("#input").value.trim();
  if(!text){
    var box = $("#inputBox"); if(!box.open) box.open = true;
    $("#input").focus(); return;
  }
  $("#rubyOut").innerHTML  = "<em style='color:#9fb0c2'>생성 중…</em>";
  $("#transOut").innerHTML = "<em style='color:#9fb0c2'>번역 중…</em>";
  try{
    var both = await Promise.all([callFurigana(text), callDeepL(text, "JA", "KO")]);
    var furi = both[0], tr = both[1];
    lastTokens = furi.tokens || [];
    renderText(); // rt 토글 방식이라 줄간격 유지
    var t = tr.translation || tr.result || tr.data || "";
    $("#transOut").innerHTML = t ? escapeHtml(t).replace(/\n/g,"<br>") : "<em style='color:#9fb0c2'>결과 없음</em>";
  }catch(e){
    $("#rubyOut").innerHTML = "<span class=\"error\">에러(후리가나): " + escapeHtml((e && e.message) ? e.message : String(e)) + "</span>";
    $("#transOut").innerHTML = "";
  }
}

/* 이벤트 바인딩 */
$("#runBtn").addEventListener("click", runBoth);
$("#btnToggleRuby").addEventListener("click", function(){
  rubyOn = !rubyOn; $("#rubyOut").classList.toggle("ruby-off", !rubyOn);
  $("#btnToggleRuby").textContent = rubyOn ? "루비 끄기" : "루비 켜기";
});
$("#rubyOut").addEventListener("click", function(e){
  var el = (e.target instanceof Element) ? e.target : null;
  while(el && !el.classList.contains("tok")) el = el.parentElement;
  if(!el || el.dataset.clickable === "0") return;
  openPop(e.clientX, e.clientY, {
    surface: el.dataset.surface || "",
    lemma:   el.dataset.lemma   || "",
    reading: el.dataset.reading || ""
  });
});
window.addEventListener("keydown", function(e){
  if((e.ctrlKey||e.metaKey) && e.key==="Enter"){ e.preventDefault(); runBoth(); }
});

/* details 열릴 때 포커스 */
$("#inputBox").addEventListener("toggle", function(){
  if($("#inputBox").open){ $("#input").focus(); }
});

/* ===== 단축어 연동: ?text=...&auto=1 (이중 인코딩 복원 포함) ===== */
function getQueryText(){
  var sp = new URLSearchParams(location.search);
  var q = sp.get("text");
  if(!q) return "";
  try { q = decodeURIComponent(q); } catch(e){}
  try { q = decodeURIComponent(q); } catch(e){}
  return q;
}
(function initFromQuery(){
  var qText = getQueryText();
  if(qText){
    $("#input").value = qText;
    if (new URLSearchParams(location.search).get("auto")==="1") { runBoth(); }
  }
})();
</script>
</body>
</html>
