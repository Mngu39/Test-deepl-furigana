<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JP → KO: Furigana + DeepL</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", "Helvetica Neue", Arial; padding:16px; max-width:820px; margin:0 auto; }
    textarea { width:100%; height:120px; font-size:18px; padding:8px; }
    button { padding:10px 14px; font-size:16px; margin-top:8px; }
    .result { margin-top:16px; padding:12px; border-radius:8px; background:#f8f8f8; }
    .ruby-area { font-size:22px; line-height:1.6; }
    .translation { margin-top:10px; color:#222; font-size:18px; }
    .small { font-size:13px; color:#666; margin-top:8px; }
  </style>
</head>
<body>
  <h2>Japanese → Korean (Furigana + DeepL)</h2>

  <label>번역/요미가나 처리할 일본어 문장:</label>
  <textarea id="inputText" placeholder="例：勉強する"></textarea>
  <div>
    <label for="deeplEndpoint">DeepL 프록시 URL (Cloudflare Worker):</label>
    <input id="deeplEndpoint" style="width:100%; padding:6px;" placeholder="https://solitary-mud-8caf.rlaalsrbr.workers.dev/translate" />
  </div>
  <button id="runBtn">변환 & 번역</button>

  <div class="result" id="resultBox" style="display:none">
    <div class="ruby-area" id="rubyHtml"></div>
    <div class="translation" id="translationText"></div>
    <div class="small">원문을 루비(요미가나)로 표기하고, DeepL 번역을 보여줍니다.</div>
  </div>

  <!-- Kuroshiro + kuromoji (unpkg CDN) -->
  <script src="https://unpkg.com/kuromoji@0.1.2/dist/kuromoji.min.js"></script>
  <script src="https://unpkg.com/kuroshiro@1.2.0/dist/kuroshiro.min.js"></script>

  <script>
    const input = document.getElementById('inputText');
    const runBtn = document.getElementById('runBtn');
    const rubyArea = document.getElementById('rubyHtml');
    const translationText = document.getElementById('translationText');
    const resultBox = document.getElementById('resultBox');
    const endpointInput = document.getElementById('deeplEndpoint');

    let kuroshiro = new Kuroshiro();
    // 빌더 경로: kuromoji dict를 unpkg에서 불러옵니다
    kuromoji.builder({ dicPath: "https://unpkg.com/kuromoji@0.1.2/dict/" }).build((err, tokenizer) => {
      if (err) {
        console.error("kuromoji build error:", err);
        alert("형태소 분석기 로딩에 실패했습니다.");
        return;
      }
      kuroshiro.init(tokenizer).then(() => {
        console.log("Kuroshiro ready");
      });
    });

    async function makeFuriganaHTML(text) {
      // mode: "furigana" => ruby 태그 포함 HTML 반환
      // to:"hiragana"로 읽음을 히라가나로 반환
      return await kuroshiro.convert(text, { mode: "furigana", to: "hiragana" });
    }

    async function fetchTranslation(workerUrl, text) {
      // workerUrl: Cloudflare Worker endpoint (보안상 여기서 DeepL 키를 직접 넣지 않음)
      // POST { text: "...", target: "KO" } 형식으로 보냄
      const res = await fetch(workerUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: text, target: "KO" })
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error("번역서버 오류: " + res.status + " " + txt);
      }
      return (await res.json()).translation || "";
    }

    runBtn.addEventListener("click", async () => {
      const text = input.value.trim();
      const workerUrl = endpointInput.value.trim();
      if (!text) { alert("문장을 입력하세요."); return; }
      if (!workerUrl) { alert("DeepL 프록시(Worker) URL을 입력하세요."); return; }

      runBtn.disabled = true;
      runBtn.textContent = "처리중…";

      try {
        const [rubyHtml, translated] = await Promise.all([
          makeFuriganaHTML(text),
          fetchTranslation(workerUrl, text)
        ]);
        rubyArea.innerHTML = rubyHtml;
        translationText.textContent = "→ " + translated;
        resultBox.style.display = "block";
      } catch (e) {
        alert("오류: " + e.message);
        console.error(e);
      } finally {
        runBtn.disabled = false;
        runBtn.textContent = "변환 & 번역";
      }
      
        // URL ?q=... 로 들어오면 자동 실행
      function autoRunFromQuery() {
        const q = new URLSearchParams(location.search).get('q');
        if (!q) return;
        const input = document.getElementById('inputText'); // 당신 페이지의 입력칸 id에 맞춰주세요
        input.value = decodeURIComponent(q);
        document.getElementById('runBtn').click(); // “변환 & 번역” 버튼 id에 맞춰주세요
      }

  document.addEventListener
    });
  </script>
</body>
</html>

