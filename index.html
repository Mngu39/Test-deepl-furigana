<!doctype html>
<html lang="ko"><!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Furigana + ë²ˆì—­</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --card:#11161f; --ink:#e6edf3; --line:#223044; --muted:#9fb0c2; --accent:#5aa9ff; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,sans-serif}
    header{padding:16px 20px;border-bottom:1px solid var(--line)}
    h1{margin:0;font-size:16px;font-weight:600}
    main{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
    .label{font-size:13px;color:var(--muted);margin-bottom:8px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:#182233;color:var(--ink);border:1px solid var(--line);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#1e2a3f}
    .btn.primary{background:var(--accent);color:#06111e;border-color:#2d80e4;font-weight:600}
    .error{color:#ffb3b3}
    textarea{width:100%;min-height:120px;background:#0e141c;color:#e6edf3;border:1px solid var(--line);border-radius:10px;padding:12px;resize:vertical;line-height:1.5}
    ruby{ruby-position:over}
    ruby rt{font-size:.8em;color:#b9c8d8;opacity:1;transition:opacity .15s ease}
    #rubyOut.ruby-off ruby rt{opacity:0}     /* ë£¨ë¹„ í† ê¸€: ì¤„ê°„ê²© ìœ ì§€ */
    .tok{padding:1px 2px;border-radius:6px;cursor:pointer}
    .tok:hover{background:#1a2436}
    .tok[data-clickable="0"]{cursor:default}
    .tok ruby, .tok rb, .tok rt { pointer-events:none; } /* ë£¨ë¹„ ë‚´ë¶€ í´ë¦­ ë²„ê·¸ ë°©ì§€ */
    .pane{height:38vh; min-height:28vh; max-height:60vh; overflow:auto; background:#0e141c; border:1px solid var(--line); border-radius:10px; padding:12px; white-space:pre-wrap}
    @media (max-height:760px){ .pane{height:34vh} }
    details summary{list-style:none; cursor:pointer; display:flex; align-items:center; gap:8px; user-select:none}
    details summary::-webkit-details-marker{display:none}
    .chev{transition:transform .2s ease}
    details[open] .chev{transform:rotate(90deg)}
    .hint{margin-left:auto; color:#9fb0c2; font-size:12px}

    /* íŒì—… */
    #pop{position:fixed;z-index:9999;max-width:360px;display:none;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .popTitle{font-size:22px;font-weight:800;line-height:1.2;display:inline-block;color:#e6edf3;text-decoration:none}
    .popTitle rt{font-size:.7em}
    .popSub{font-size:12px;color:#9fb0c2;margin-left:6px}
    .popTrans{font-size:15px;color:#cfe0f2;margin-top:8px;word-break:break-word}
    .popActions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    /* ğŸ”» í•œì ì¹©: í•œ ì¤„ì— í•˜ë‚˜ì”©(ì„¸ë¡œ), í›ˆ/ìŒ êµ¬ë¶„ ê°€ë… */
    .kochips{
      display:flex;
      flex-direction:column;   /* ì„¸ë¡œ ë°°ì¹˜ */
      gap:8px;                 /* ì¤„ ê°„ ê°„ê²© */
      margin-top:8px;
    }
    .kochip{
      display:block;           /* ì¤„ë°”ê¿ˆ ê°•ì œ */
      border:1px solid var(--line);
      background:#182233;
      color:#cfe0f2;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      text-decoration:none;
      width:max-content;       /* í…ìŠ¤íŠ¸ ê¸¸ì´ë§Œí¼ */
    }
    .kochip:hover{ background:#20304a }
  </style>
</head>
<body>
<header><h1>Furigana + ë²ˆì—­</h1></header>
<main>

  <!-- ì…ë ¥(ì ‘í˜) -->
  <section class="card">
    <details id="inputBox">
      <summary>
        <span class="chev">â–¶</span>
        <strong>ì…ë ¥ í…ìŠ¤íŠ¸</strong>
        <span class="hint">í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸° Â· ë‹¨ì¶•í‚¤ Ctrl/âŒ˜+Enter</span>
      </summary>
      <div style="margin-top:10px">
        <textarea id="input" placeholder="ì¼ë³¸ì–´ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³  â€˜í›„ë¦¬ê°€ë‚˜ & ë²ˆì—­â€™ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”ã€‚"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="runBtn" type="button">í›„ë¦¬ê°€ë‚˜ & ë²ˆì—­</button>
        </div>
      </div>
    </details>
  </section>

  <!-- ì›ë¬¸(ë£¨ë¹„ í† ê¸€, ë…ë¦½ ìŠ¤í¬ë¡¤) -->
  <section class="card">
    <div class="label" style="margin-bottom:8px">ì›ë¬¸</div>
    <div id="rubyOut" class="pane" aria-live="polite"></div>
    <div class="row" style="margin-top:8px; justify-content:flex-end">
      <button class="btn" id="btnToggleRuby" type="button">ë£¨ë¹„ ë„ê¸°</button>
    </div>
  </section>

  <!-- ë²ˆì—­(ë…ë¦½ ìŠ¤í¬ë¡¤) -->
  <section class="card">
    <div class="label" style="margin-bottom:8px">ë²ˆì—­</div>
    <div id="transOut" class="pane" aria-live="polite"></div>
  </section>
</main>

<!-- ë‹¨ì–´ íŒì—… -->
<div id="pop">
  <!-- í—¤ë”: ê¸°ë³¸í˜•(í° ê¸€ì”¨, "ê¸°ë³¸í˜•ì˜ ì½ê¸°"ë¥¼ rtë¡œ), (ì„ íƒ ê¸€ì) ì‘ê²Œ -->
  <a id="popLink" class="popTitle" href="#" target="_blank" rel="noopener"></a>
  <span id="popSub" class="popSub"></span>
  <!-- ë²ˆì—­ í…ìŠ¤íŠ¸ -->
  <div id="popDeepl" class="popTrans"></div>
  <!-- í•œì í›ˆÂ·ìŒ ì¹© -->
  <div id="popKo" class="kochips" style="display:none"></div>
  <div class="popActions"><button class="btn" id="popClose" type="button">ë‹«ê¸°</button></div>
</div>

<script>
/* ===== ê³ ì • ì—”ë“œí¬ì¸íŠ¸ ===== */
const FURIGANA_URL = "https://furigana-api-345684237835.asia-northeast3.run.app/furigana";
const DEEPL_URL    = "https://solitary-mud-8caf.rlaalsrbr.workers.dev/translate";
/* ë¡œì»¬ í•œì-í•œêµ­ì–´ DB (index.htmlê³¼ ê°™ì€ í´ë”) */
const KANJI_DB_URL = "./kanji_ko_attr_irreg.min.json";

/* ===== ìœ í‹¸ ===== */
const $ = (s)=>document.querySelector(s);
function escapeHtml(s){ const d=document.createElement("div"); d.innerText=s; return d.innerHTML; }
function escapeAttr(s){ return String(s).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;"); }
function kata2hira(s){ return s.replace(/[\u30a1-\u30f6]/g, ch=>String.fromCharCode(ch.charCodeAt(0)-0x60)); }
function hasKanji(s){ return /[\u4E00-\u9FFF]/.test(s); }
function withTimeout(run, ms=45000, label="ìš”ì²­"){
  const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), ms);
  return Promise.race([
    run(ctrl.signal),
    (async()=>{ await new Promise(r=>setTimeout(r, ms+50)); throw new Error(label+" íƒ€ì„ì•„ì›ƒ("+ms+"ms)"); })()
  ]).finally(()=>clearTimeout(t));
}

/* ë„“ì€ ê³µë°±(EM SPACE Ã—2) â€” í›ˆ/ìŒ ì‚¬ì´ êµ¬ë¶„ìš© */
const SEP_WIDE = " ";

/* ===== API ===== */
async function callFurigana(text){
  const body={ text, perChar:false };
  const fetcher=(signal)=>fetch(FURIGANA_URL,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(body), signal })
    .then(r=>{ if(!r.ok) throw new Error("Furigana API "+r.status); return r.json(); });
  return withTimeout(fetcher, 45000, "Furigana");
}
async function callDeepL(text, src="JA", tgt="KO"){
  const body={ text, sourceLang:src, targetLang:tgt };
  const fetcher=(signal)=>fetch(DEEPL_URL,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(body), signal })
    .then(r=>{ if(!r.ok) throw new Error("DeepL "+r.status); return r.json(); });
  return withTimeout(fetcher, 45000, "DeepL");
}

/* ===== ë¡œì»¬ í•œì DB ===== */
let KANJI_DB = null;
async function loadKanjiDB(){
  if (KANJI_DB) return KANJI_DB;
  const res = await fetch(KANJI_DB_URL, { cache:"force-cache" });
  if (!res.ok) throw new Error("kanji DB load " + res.status);
  KANJI_DB = await res.json();
  return KANJI_DB;
}

/* ===== ìƒíƒœ ===== */
let lastTokens=null;
let rubyOn=true;

/* ===== ruby DOM(í•­ìƒ ìƒì„±: rtë¥¼ CSSë¡œ ìˆ¨ê¹€) ===== */
function buildRubyTokens(tokens){
  return (tokens||[]).map((t, idx)=>{
    const s=String(t.surface||"");
    const r=String(t.reading||"");
    const lemma=String(t.lemma||s);
    const rt=r?kata2hira(r):"";
    const inner=(hasKanji(s)&&rt)
      ? '<ruby><rb>'+escapeHtml(s)+'</rb><rt>'+escapeHtml(rt)+'</rt></ruby>'
      : escapeHtml(s);
    const clickable=s.trim()?"1":"0";
    return '<span class="tok" data-i="'+idx+'" data-clickable="'+clickable+'"'
         + ' data-surface="'+escapeAttr(s)+'"'
         + ' data-lemma="'+escapeAttr(lemma)+'"'
         + ' data-reading="'+escapeAttr(rt)+'">'+ inner +'</span>';
  }).join("");
}
function renderText(){
  if(!lastTokens) return;
  $("#rubyOut").innerHTML = buildRubyTokens(lastTokens);
  $("#rubyOut").classList.toggle("ruby-off", !rubyOn);
  $("#btnToggleRuby").textContent = rubyOn ? "ë£¨ë¹„ ë„ê¸°" : "ë£¨ë¹„ ì¼œê¸°";
}

/* ===== lemma ì½ê¸° ìºì‹œ ===== */
const lemmaReadCache=new Map();
function readingFromTokens(tokens){
  return (tokens||[]).map(t=>{
    const s=String(t.surface||"");
    const r=String(t.reading||"");
    return r?kata2hira(r):s;
  }).join("");
}
function getLemmaReading(lemma){
  if(!lemma) return Promise.resolve("");
  if(lemmaReadCache.has(lemma)) return Promise.resolve(lemmaReadCache.get(lemma));
  return callFurigana(lemma).then(res=>{
    const rt=readingFromTokens(res.tokens||[]);
    lemmaReadCache.set(lemma, rt);
    return rt;
  }).catch(()=>{ lemmaReadCache.set(lemma, ""); return ""; });
}

/* ===== íŒì—… ===== */
const pop=$("#pop");
const popLink=$("#popLink");
const popSub=$("#popSub");
const popDeepl=$("#popDeepl");
const popKo=$("#popKo");

function buildNaverSearchUrl(q){
  return "https://ja.dict.naver.com/#/search?query=" + encodeURIComponent(q || "");
}

async function renderKoChipsForLemma(lemma){
  popKo.style.display="none";
  popKo.innerHTML="";
  try{
    const db = await loadKanjiDB();
    const seen = new Set();
    const chips = [];

    for (const ch of Array.from(lemma)){
      if (!/[\u4E00-\u9FFF]/.test(ch)) continue;   // í•œìë§Œ
      if (seen.has(ch)) continue;
      seen.add(ch);

      const rec = db[ch];  // {ìŒ:"", í›ˆ:""} ë˜ëŠ” undefined
      if (!rec) continue;

      const hun = rec["í›ˆ"] || "";
      const eum = rec["ìŒ"] || "";

      // í›ˆ ë¨¼ì €, ë„“ì€ ê³µë°± í›„ ìŒ
      let kr = "";
      if (hun) kr += hun;
      if (hun && eum) kr += SEP_WIDE;
      if (eum) kr += eum;

      const label = kr ? `${ch} Â· ${kr}` : ch;

      const href  = "https://hanja.dict.naver.com/#/search?query=" + encodeURIComponent(ch);
      chips.push(
        '<a class="kochip" href="'+escapeAttr(href)+'" target="_blank" rel="noopener">'
        + escapeHtml(label) + '</a>'
      );
    }

    if (chips.length){
      popKo.innerHTML = chips.join("");
      popKo.style.display = "flex";   /* ì„¸ë¡œ ë¦¬ìŠ¤íŠ¸ ë³´ì´ê¸° */
    }
  }catch(e){
    /* ì¡°ìš©íˆ ë¬´ì‹œ */
  }
}

function openPop(x, y, payload){
  const surface = payload.surface || "";
  const lemma   = payload.lemma   || surface;

  // í—¤ë” ë§í¬: ë„¤ì´ë²„ ê²€ìƒ‰ í˜ì´ì§€
  popLink.innerHTML = escapeHtml(lemma);
  popLink.href = buildNaverSearchUrl(lemma);
  popSub.textContent = (surface && surface!==lemma) ? "(" + surface + ")" : "";

  // lemma ì½ê¸°(rt)ë¡œ í—¤ë”ë¥¼ rubyë¡œ ì—…ë°ì´íŠ¸
  if(hasKanji(lemma)){
    getLemmaReading(lemma).then(rt=>{
      popLink.innerHTML = rt
        ? '<ruby><rb>'+escapeHtml(lemma)+'</rb><rt>'+escapeHtml(rt)+'</rt></ruby>'
        : escapeHtml(lemma);
    });
  }

  // ë²ˆì—­(lemma ê¸°ì¤€)
  popDeepl.textContent="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
  callDeepL(lemma, "JA", "KO").then(res=>{
    const t = res.translation || res.result || res.data || "";
    popDeepl.textContent = t || "(ê²°ê³¼ ì—†ìŒ)";
  }).catch(e=>{
    popDeepl.textContent = "ì—ëŸ¬: " + (e && e.message ? e.message : String(e));
  });

  // í•œì í›ˆÂ·ìŒ ì¹© (ë¡œì»¬ DB)
  renderKoChipsForLemma(lemma);

  // ìœ„ì¹˜ ë° í‘œì‹œ
  const pad=8, vw=window.innerWidth, vh=window.innerHeight;
  pop.style.left = Math.min(x+pad, vw-380) + "px";
  pop.style.top  = Math.min(y+pad, vh-260) + "px";
  pop.style.display = "block";
}
function closePop(){ pop.style.display="none"; }
$("#popClose").addEventListener("click", closePop);
document.addEventListener("click", (e)=>{
  if(pop.style.display==="block"){
    if(!pop.contains(e.target) && !e.target.closest(".tok")) closePop();
  }
});

/* ===== ì‹¤í–‰ ===== */
async function runBoth(){
  const text = $("#input").value.trim();
  if(!text){
    const box=$("#inputBox"); if(!box.open) box.open=true;
    $("#input").focus(); return;
  }
  $("#rubyOut").innerHTML  = "<em style='color:#9fb0c2'>ìƒì„± ì¤‘â€¦</em>";
  $("#transOut").innerHTML = "<em style='color:#9fb0c2'>ë²ˆì—­ ì¤‘â€¦</em>";
  try{
    const [furi, tr] = await Promise.all([callFurigana(text), callDeepL(text, "JA", "KO")]);
    lastTokens = furi.tokens || [];
    renderText(); // rt í† ê¸€ ë°©ì‹ì´ë¼ ì¤„ê°„ê²© ìœ ì§€
    const t = tr.translation || tr.result || tr.data || "";
    $("#transOut").innerHTML = t ? escapeHtml(t).replace(/\n/g,"<br>") : "<em style='color:#9fb0c2'>ê²°ê³¼ ì—†ìŒ</em>";
  }catch(e){
    $("#rubyOut").innerHTML = '<span class="error">ì—ëŸ¬(í›„ë¦¬ê°€ë‚˜): '+escapeHtml(e && e.message ? e.message : String(e))+'</span>';
    $("#transOut").innerHTML = "";
  }
}

/* ì´ë²¤íŠ¸ ë°”ì¸ë”© */
$("#runBtn").addEventListener("click", runBoth);
$("#btnToggleRuby").addEventListener("click", ()=>{
  rubyOn = !rubyOn;
  $("#rubyOut").classList.toggle("ruby-off", !rubyOn);
  $("#btnToggleRuby").textContent = rubyOn ? "ë£¨ë¹„ ë„ê¸°" : "ë£¨ë¹„ ì¼œê¸°";
});
$("#rubyOut").addEventListener("click", (e)=>{
  let el = (e.target instanceof Element) ? e.target : null;
  while(el && !el.classList.contains("tok")) el = el.parentElement;
  if(!el || el.dataset.clickable === "0") return;
  openPop(e.clientX, e.clientY, {
    surface: el.dataset.surface || "",
    lemma:   el.dataset.lemma   || ""
  });
});
window.addEventListener("keydown", (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key==="Enter"){ e.preventDefault(); runBoth(); }
});

/* details ì—´ë¦´ ë•Œ í¬ì»¤ìŠ¤ */
$("#inputBox").addEventListener("toggle", ()=>{
  if($("#inputBox").open){ $("#input").focus(); }
});

/* ===== ë‹¨ì¶•ì–´ ì—°ë™: ?text=...&auto=1 (ì´ì¤‘ ì¸ì½”ë”© ë³µì› í¬í•¨) ===== */
function getQueryText(){
  const sp=new URLSearchParams(location.search);
  let q = sp.get("text");
  if(!q) return "";
  try{ q = decodeURIComponent(q); }catch(_){}
  try{ q = decodeURIComponent(q); }catch(_){}
  return q;
}
(function initFromQuery(){
  const qText = getQueryText();
  if(qText){
    $("#input").value = qText;
    if (new URLSearchParams(location.search).get("auto")==="1") { runBoth(); }
  }
})();
</script>
</body>
</html>

<head>
  <meta charset="utf-8" />
  <title>Furigana + ë²ˆì—­</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --card:#11161f; --ink:#e6edf3; --line:#223044; --muted:#9fb0c2; --accent:#5aa9ff; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,sans-serif}
    header{padding:16px 20px;border-bottom:1px solid var(--line)}
    h1{margin:0;font-size:16px;font-weight:600}
    main{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
    .label{font-size:13px;color:var(--muted);margin-bottom:8px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:#182233;color:var(--ink);border:1px solid var(--line);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#1e2a3f}
    .btn.primary{background:var(--accent);color:#06111e;border-color:#2d80e4;font-weight:600}
    .error{color:#ffb3b3}
    textarea{width:100%;min-height:120px;background:#0e141c;color:#e6edf3;border:1px solid var(--line);border-radius:10px;padding:12px;resize:vertical;line-height:1.5}
    ruby{ruby-position:over}
    ruby rt{font-size:.8em;color:#b9c8d8;opacity:1;transition:opacity .15s ease}
    #rubyOut.ruby-off ruby rt{opacity:0}     /* ë£¨ë¹„ í† ê¸€: ì¤„ê°„ê²© ìœ ì§€ */
    .tok{padding:1px 2px;border-radius:6px;cursor:pointer}
    .tok:hover{background:#1a2436}
    .tok[data-clickable="0"]{cursor:default}
    .tok ruby, .tok rb, .tok rt { pointer-events:none; } /* ë£¨ë¹„ ë‚´ë¶€ í´ë¦­ ë²„ê·¸ ë°©ì§€ */
    .pane{height:38vh; min-height:28vh; max-height:60vh; overflow:auto; background:#0e141c; border:1px solid var(--line); border-radius:10px; padding:12px; white-space:pre-wrap}
    @media (max-height:760px){ .pane{height:34vh} }
    details summary{list-style:none; cursor:pointer; display:flex; align-items:center; gap:8px; user-select:none}
    details summary::-webkit-details-marker{display:none}
    .chev{transition:transform .2s ease}
    details[open] .chev{transform:rotate(90deg)}
    .hint{margin-left:auto; color:#9fb0c2; font-size:12px}

    /* íŒì—… */
    #pop{position:fixed;z-index:9999;max-width:360px;display:none;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .popTitle{font-size:22px;font-weight:800;line-height:1.2;display:inline-block;color:#e6edf3;text-decoration:none}
    .popTitle rt{font-size:.7em}
    .popSub{font-size:12px;color:#9fb0c2;margin-left:6px}
    .popTrans{font-size:15px;color:#cfe0f2;margin-top:8px;word-break:break-word}
    .popActions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    /* ğŸ”» í•œì ì¹©: í•œ ì¤„ì— í•˜ë‚˜ì”©(ì„¸ë¡œ), í›ˆ/ìŒ êµ¬ë¶„ ê°€ë… */
    .kochips{
      display:flex;
      flex-direction:column;   /* ì„¸ë¡œ ë°°ì¹˜ */
      gap:8px;                 /* ì¤„ ê°„ ê°„ê²© */
      margin-top:8px;
    }
    .kochip{
      display:block;           /* ì¤„ë°”ê¿ˆ ê°•ì œ */
      border:1px solid var(--line);
      background:#182233;
      color:#cfe0f2;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      text-decoration:none;
      width:max-content;       /* í…ìŠ¤íŠ¸ ê¸¸ì´ë§Œí¼ */
    }
    .kochip:hover{ background:#20304a }
  </style>
</head>
<body>
<header><h1>Furigana + ë²ˆì—­</h1></header>
<main>

  <!-- ì…ë ¥(ì ‘í˜) -->
  <section class="card">
    <details id="inputBox">
      <summary>
        <span class="chev">â–¶</span>
        <strong>ì…ë ¥ í…ìŠ¤íŠ¸</strong>
        <span class="hint">í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸° Â· ë‹¨ì¶•í‚¤ Ctrl/âŒ˜+Enter</span>
      </summary>
      <div style="margin-top:10px">
        <textarea id="input" placeholder="ì¼ë³¸ì–´ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê³  â€˜í›„ë¦¬ê°€ë‚˜ & ë²ˆì—­â€™ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”ã€‚"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="runBtn" type="button">í›„ë¦¬ê°€ë‚˜ & ë²ˆì—­</button>
        </div>
      </div>
    </details>
  </section>

  <!-- ì›ë¬¸(ë£¨ë¹„ í† ê¸€, ë…ë¦½ ìŠ¤í¬ë¡¤) -->
  <section class="card">
    <div class="label" style="margin-bottom:8px">ì›ë¬¸</div>
    <div id="rubyOut" class="pane" aria-live="polite"></div>
    <div class="row" style="margin-top:8px; justify-content:flex-end">
      <button class="btn" id="btnToggleRuby" type="button">ë£¨ë¹„ ë„ê¸°</button>
    </div>
  </section>

  <!-- ë²ˆì—­(ë…ë¦½ ìŠ¤í¬ë¡¤) -->
  <section class="card">
    <div class="label" style="margin-bottom:8px">ë²ˆì—­</div>
    <div id="transOut" class="pane" aria-live="polite"></div>
  </section>
</main>

<!-- ë‹¨ì–´ íŒì—… -->
<div id="pop">
  <!-- í—¤ë”: ê¸°ë³¸í˜•(í° ê¸€ì”¨, "ê¸°ë³¸í˜•ì˜ ì½ê¸°"ë¥¼ rtë¡œ), (ì„ íƒ ê¸€ì) ì‘ê²Œ -->
  <a id="popLink" class="popTitle" href="#" target="_blank" rel="noopener"></a>
  <span id="popSub" class="popSub"></span>
  <!-- ë²ˆì—­ í…ìŠ¤íŠ¸ -->
  <div id="popDeepl" class="popTrans"></div>
  <!-- í•œì í›ˆÂ·ìŒ ì¹© -->
  <div id="popKo" class="kochips" style="display:none"></div>
  <div class="popActions"><button class="btn" id="popClose" type="button">ë‹«ê¸°</button></div>
</div>

<script>
/* ===== ê³ ì • ì—”ë“œí¬ì¸íŠ¸ ===== */
const FURIGANA_URL = "https://furigana-api-345684237835.asia-northeast3.run.app/furigana";
const DEEPL_URL    = "https://solitary-mud-8caf.rlaalsrbr.workers.dev/translate";
/* ë¡œì»¬ í•œì-í•œêµ­ì–´ DB (index.htmlê³¼ ê°™ì€ í´ë”) */
const KANJI_DB_URL = "./kanji_ko.min.json";

/* ===== ìœ í‹¸ ===== */
const $ = (s)=>document.querySelector(s);
function escapeHtml(s){ const d=document.createElement("div"); d.innerText=s; return d.innerHTML; }
function escapeAttr(s){ return String(s).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;"); }
function kata2hira(s){ return s.replace(/[\u30a1-\u30f6]/g, ch=>String.fromCharCode(ch.charCodeAt(0)-0x60)); }
function hasKanji(s){ return /[\u4E00-\u9FFF]/.test(s); }
function withTimeout(run, ms=45000, label="ìš”ì²­"){
  const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), ms);
  return Promise.race([
    run(ctrl.signal),
    (async()=>{ await new Promise(r=>setTimeout(r, ms+50)); throw new Error(label+" íƒ€ì„ì•„ì›ƒ("+ms+"ms)"); })()
  ]).finally(()=>clearTimeout(t));
}

/* ë„“ì€ ê³µë°±(EM SPACE Ã—2) â€” í›ˆ/ìŒ ì‚¬ì´ êµ¬ë¶„ìš© */
const SEP_WIDE = "\u00A0\u00A0";

/* ===== API ===== */
async function callFurigana(text){
  const body={ text, perChar:false };
  const fetcher=(signal)=>fetch(FURIGANA_URL,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(body), signal })
    .then(r=>{ if(!r.ok) throw new Error("Furigana API "+r.status); return r.json(); });
  return withTimeout(fetcher, 45000, "Furigana");
}
async function callDeepL(text, src="JA", tgt="KO"){
  const body={ text, sourceLang:src, targetLang:tgt };
  const fetcher=(signal)=>fetch(DEEPL_URL,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(body), signal })
    .then(r=>{ if(!r.ok) throw new Error("DeepL "+r.status); return r.json(); });
  return withTimeout(fetcher, 45000, "DeepL");
}

/* ===== ë¡œì»¬ í•œì DB ===== */
let KANJI_DB = null;
async function loadKanjiDB(){
  if (KANJI_DB) return KANJI_DB;
  const res = await fetch(KANJI_DB_URL, { cache:"force-cache" });
  if (!res.ok) throw new Error("kanji DB load " + res.status);
  KANJI_DB = await res.json();
  return KANJI_DB;
}

/* ===== ìƒíƒœ ===== */
let lastTokens=null;
let rubyOn=true;

/* ===== ruby DOM(í•­ìƒ ìƒì„±: rtë¥¼ CSSë¡œ ìˆ¨ê¹€) ===== */
function buildRubyTokens(tokens){
  return (tokens||[]).map((t, idx)=>{
    const s=String(t.surface||"");
    const r=String(t.reading||"");
    const lemma=String(t.lemma||s);
    const rt=r?kata2hira(r):"";
    const inner=(hasKanji(s)&&rt)
      ? '<ruby><rb>'+escapeHtml(s)+'</rb><rt>'+escapeHtml(rt)+'</rt></ruby>'
      : escapeHtml(s);
    const clickable=s.trim()?"1":"0";
    return '<span class="tok" data-i="'+idx+'" data-clickable="'+clickable+'"'
         + ' data-surface="'+escapeAttr(s)+'"'
         + ' data-lemma="'+escapeAttr(lemma)+'"'
         + ' data-reading="'+escapeAttr(rt)+'">'+ inner +'</span>';
  }).join("");
}
function renderText(){
  if(!lastTokens) return;
  $("#rubyOut").innerHTML = buildRubyTokens(lastTokens);
  $("#rubyOut").classList.toggle("ruby-off", !rubyOn);
  $("#btnToggleRuby").textContent = rubyOn ? "ë£¨ë¹„ ë„ê¸°" : "ë£¨ë¹„ ì¼œê¸°";
}

/* ===== lemma ì½ê¸° ìºì‹œ ===== */
const lemmaReadCache=new Map();
function readingFromTokens(tokens){
  return (tokens||[]).map(t=>{
    const s=String(t.surface||"");
    const r=String(t.reading||"");
    return r?kata2hira(r):s;
  }).join("");
}
function getLemmaReading(lemma){
  if(!lemma) return Promise.resolve("");
  if(lemmaReadCache.has(lemma)) return Promise.resolve(lemmaReadCache.get(lemma));
  return callFurigana(lemma).then(res=>{
    const rt=readingFromTokens(res.tokens||[]);
    lemmaReadCache.set(lemma, rt);
    return rt;
  }).catch(()=>{ lemmaReadCache.set(lemma, ""); return ""; });
}

/* ===== íŒì—… ===== */
const pop=$("#pop");
const popLink=$("#popLink");
const popSub=$("#popSub");
const popDeepl=$("#popDeepl");
const popKo=$("#popKo");

function buildNaverSearchUrl(q){
  return "https://ja.dict.naver.com/#/search?query=" + encodeURIComponent(q || "");
}

async function renderKoChipsForLemma(lemma){
  popKo.style.display="none";
  popKo.innerHTML="";
  try{
    const db = await loadKanjiDB();
    const seen = new Set();
    const chips = [];

    for (const ch of Array.from(lemma)){
      if (!/[\u4E00-\u9FFF]/.test(ch)) continue;   // í•œìë§Œ
      if (seen.has(ch)) continue;
      seen.add(ch);

      const rec = db[ch];  // {ìŒ:"", í›ˆ:""} ë˜ëŠ” undefined
      if (!rec) continue;

      const hun = rec["í›ˆ"] || "";
      const eum = rec["ìŒ"] || "";

      // í›ˆ ë¨¼ì €, ë„“ì€ ê³µë°± í›„ ìŒ
      let kr = "";
      if (hun) kr += hun;
      if (hun && eum) kr += SEP_WIDE;
      if (eum) kr += eum;

      const label = kr ? `${ch} Â· ${kr}` : ch;

      const href  = "https://hanja.dict.naver.com/#/search?query=" + encodeURIComponent(ch);
      chips.push(
        '<a class="kochip" href="'+escapeAttr(href)+'" target="_blank" rel="noopener">'
        + escapeHtml(label) + '</a>'
      );
    }

    if (chips.length){
      popKo.innerHTML = chips.join("");
      popKo.style.display = "flex";   /* ì„¸ë¡œ ë¦¬ìŠ¤íŠ¸ ë³´ì´ê¸° */
    }
  }catch(e){
    /* ì¡°ìš©íˆ ë¬´ì‹œ */
  }
}

function openPop(x, y, payload){
  const surface = payload.surface || "";
  const lemma   = payload.lemma   || surface;

  // í—¤ë” ë§í¬: ë„¤ì´ë²„ ê²€ìƒ‰ í˜ì´ì§€
  popLink.innerHTML = escapeHtml(lemma);
  popLink.href = buildNaverSearchUrl(lemma);
  popSub.textContent = (surface && surface!==lemma) ? "(" + surface + ")" : "";

  // lemma ì½ê¸°(rt)ë¡œ í—¤ë”ë¥¼ rubyë¡œ ì—…ë°ì´íŠ¸
  if(hasKanji(lemma)){
    getLemmaReading(lemma).then(rt=>{
      popLink.innerHTML = rt
        ? '<ruby><rb>'+escapeHtml(lemma)+'</rb><rt>'+escapeHtml(rt)+'</rt></ruby>'
        : escapeHtml(lemma);
    });
  }

  // ë²ˆì—­(lemma ê¸°ì¤€)
  popDeepl.textContent="ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
  callDeepL(lemma, "JA", "KO").then(res=>{
    const t = res.translation || res.result || res.data || "";
    popDeepl.textContent = t || "(ê²°ê³¼ ì—†ìŒ)";
  }).catch(e=>{
    popDeepl.textContent = "ì—ëŸ¬: " + (e && e.message ? e.message : String(e));
  });

  // í•œì í›ˆÂ·ìŒ ì¹© (ë¡œì»¬ DB)
  renderKoChipsForLemma(lemma);

  // ìœ„ì¹˜ ë° í‘œì‹œ
  const pad=8, vw=window.innerWidth, vh=window.innerHeight;
  pop.style.left = Math.min(x+pad, vw-380) + "px";
  pop.style.top  = Math.min(y+pad, vh-260) + "px";
  pop.style.display = "block";
}
function closePop(){ pop.style.display="none"; }
$("#popClose").addEventListener("click", closePop);
document.addEventListener("click", (e)=>{
  if(pop.style.display==="block"){
    if(!pop.contains(e.target) && !e.target.closest(".tok")) closePop();
  }
});

/* ===== ì‹¤í–‰ ===== */
async function runBoth(){
  const text = $("#input").value.trim();
  if(!text){
    const box=$("#inputBox"); if(!box.open) box.open=true;
    $("#input").focus(); return;
  }
  $("#rubyOut").innerHTML  = "<em style='color:#9fb0c2'>ìƒì„± ì¤‘â€¦</em>";
  $("#transOut").innerHTML = "<em style='color:#9fb0c2'>ë²ˆì—­ ì¤‘â€¦</em>";
  try{
    const [furi, tr] = await Promise.all([callFurigana(text), callDeepL(text, "JA", "KO")]);
    lastTokens = furi.tokens || [];
    renderText(); // rt í† ê¸€ ë°©ì‹ì´ë¼ ì¤„ê°„ê²© ìœ ì§€
    const t = tr.translation || tr.result || tr.data || "";
    $("#transOut").innerHTML = t ? escapeHtml(t).replace(/\n/g,"<br>") : "<em style='color:#9fb0c2'>ê²°ê³¼ ì—†ìŒ</em>";
  }catch(e){
    $("#rubyOut").innerHTML = '<span class="error">ì—ëŸ¬(í›„ë¦¬ê°€ë‚˜): '+escapeHtml(e && e.message ? e.message : String(e))+'</span>';
    $("#transOut").innerHTML = "";
  }
}

/* ì´ë²¤íŠ¸ ë°”ì¸ë”© */
$("#runBtn").addEventListener("click", runBoth);
$("#btnToggleRuby").addEventListener("click", ()=>{
  rubyOn = !rubyOn;
  $("#rubyOut").classList.toggle("ruby-off", !rubyOn);
  $("#btnToggleRuby").textContent = rubyOn ? "ë£¨ë¹„ ë„ê¸°" : "ë£¨ë¹„ ì¼œê¸°";
});
$("#rubyOut").addEventListener("click", (e)=>{
  let el = (e.target instanceof Element) ? e.target : null;
  while(el && !el.classList.contains("tok")) el = el.parentElement;
  if(!el || el.dataset.clickable === "0") return;
  openPop(e.clientX, e.clientY, {
    surface: el.dataset.surface || "",
    lemma:   el.dataset.lemma   || ""
  });
});
window.addEventListener("keydown", (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key==="Enter"){ e.preventDefault(); runBoth(); }
});

/* details ì—´ë¦´ ë•Œ í¬ì»¤ìŠ¤ */
$("#inputBox").addEventListener("toggle", ()=>{
  if($("#inputBox").open){ $("#input").focus(); }
});

/* ===== ë‹¨ì¶•ì–´ ì—°ë™: ?text=...&auto=1 (ì´ì¤‘ ì¸ì½”ë”© ë³µì› í¬í•¨) ===== */
function getQueryText(){
  const sp=new URLSearchParams(location.search);
  let q = sp.get("text");
  if(!q) return "";
  try{ q = decodeURIComponent(q); }catch(_){}
  try{ q = decodeURIComponent(q); }catch(_){}
  return q;
}
(function initFromQuery(){
  const qText = getQueryText();
  if(qText){
    $("#input").value = qText;
    if (new URLSearchParams(location.search).get("auto")==="1") { runBoth(); }
  }
})();
</script>
</body>
</html>




